name: Convert surge/*.list to surge/*.yaml

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */12 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Convert all .list to .yaml
        run: |
          python3 <<'EOF'
import glob
import os

types = ['DOMAIN', 'DOMAIN-SUFFIX', 'DOMAIN-KEYWORD', 'IP-CIDR', 'IP-ASN']

for txtfile in glob.glob('surge/*.list'):
    yaml_file = os.path.splitext(txtfile)[0] + '.yaml'
    entries = []
    with open(txtfile, encoding='utf-8') as f:
        for line in f:
            line = line.strip()
            if not line or line.startswith('#'):
                continue
            for t in types:
                if line.startswith(t+','):
                    entries.append(line)
                    break
    entries = sorted(set(entries))
    with open(yaml_file, 'w', encoding='utf-8') as fout:
        fout.write('payload:\n')
        for item in entries:
            fout.write(f'  - {item}\n')
EOF

      - name: Commit and Push YAML files
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          if [[ -n "$(git status --porcelain surge/*.yaml)" ]]; then
            git add surge/*.yaml
            git commit -m "Auto update yaml files from *.list"
            git push
          else
            echo "No YAML files updated."
          fi
