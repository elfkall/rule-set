name: Update YAML files from surge/list every hour

on:
  # 每小时自动运行
  schedule:
    - cron: '0 * * * *'
  # 也可手动触发
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ruleset

      - name: Convert surge/*.list to surge/*.yaml
        run: |
          for infile in surge/*.list; do
            outfile="${infile%.list}.yaml"
            # 生成 yaml 内容
            echo "payload:" > "$outfile"
            # 遍历每行，忽略空行和注释，只保留正确类型
            grep -E '^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|IP-CIDR|IP-ASN),' "$infile" | sed '/^#/d;/^$/d' | sort -u | sed 's/^/  - /' >> "$outfile"
            echo "Generated $outfile from $infile"
          done

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          # 确认 yaml 文件有更新再 commit/push
          git add surge/*.yaml
          if ! git diff --cached --quiet; then
            git commit -m "Auto update surge/*.yaml from .list files"
            git push
          else
            echo "No changes to commit."
          fi
