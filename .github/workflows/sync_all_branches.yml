name: Sync upstream

on:
  schedule:
    - cron: '0 2 * * *'        # 每天凌晨2点定时运行
  workflow_dispatch:            # 可手动触发

env:
  UPSTREAM_REPO: QuixoticHeart/rule-set    # 需替换为原仓库路径, 例: torvalds/linux
  BRANCHES: main,dev,release           # 需替换为你要同步的分支（逗号分隔）

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                   # 拉取全部提交历史，以保证可合并

      - name: Set up git user
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Add upstream repo
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream --all

      - name: Sync branches from upstream
        run: |
          IFS=',' read -ra BRLIST <<< "${BRANCHES}"
          for branch in "${BRLIST[@]}"; do
            echo "Syncing branch: $branch"
            # 检查分支是否存在
            if git show-ref --verify --quiet refs/heads/$branch; then
              git checkout $branch
            else
              # 如果本地没有分支，创建并同步 upstream 的
              git checkout -b $branch upstream/$branch || continue
            fi

            # 拉取 upsteam/$branch 并合并，不强推，不会删你自己的新文件。
            git fetch upstream $branch
            # 合并
            git merge upstream/$branch --allow-unrelated-histories -m "Sync upstream/$branch" || \
              git merge upstream/$branch -X ours --allow-unrelated-histories -m "Sync upstream/$branch (ours)"
            # 推送
            git push origin $branch
          done

